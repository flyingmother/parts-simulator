<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파츠 보정 시뮬레이터</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-top: 4px; }
        .section { margin-bottom: 20px; }
        .section h3 { font-size: 1.2rem; margin-bottom: 10px; }
        .stat-input { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; }
        .button-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 10px; border-radius: 4px; border: none; cursor: pointer; }
        .primary { background: #2563eb; color: white; }
        .secondary { background: white; border: 1px solid #ddd; }
        label { display: block; }
        .info-box { background: #f8f9fa; padding: 12px; border-radius: 4px; margin-top: 8px; }
        .stat-value { width: 120px !important; }
    </style>
</head>
<body>
    <div class="card">
        <div class="title">파츠 보정 시뮬레이터</div>
        
        <div class="grid">
            <div>
                <label>무기 종류</label>
                <select id="weaponType">
                    <option value="attack">공격보너스 무기</option>
                    <option value="crit">치명피해 무기</option>
                </select>
            </div>
            <div>
                <label>부품 종류</label>
                <select id="partType">
                    <option value="barrel">총구</option>
                    <option value="part">파츠</option>
                </select>
            </div>
        </div>

        <div class="section">
            <h3>보정 수치 입력</h3>
            <div id="statInputs"></div>
        </div>

        <div class="section">
            <h3>데미지 점수</h3>
            <div id="damageStats" class="info-box"></div>
        </div>

        <div class="section">
            <h3>골드 소모</h3>
            <div id="goldStats" class="info-box"></div>
        </div>

        <div class="button-group">
            <button class="primary" onclick="simulate()">보정 시도 (20,000 골드)</button>
            <button class="secondary" onclick="resetStats()">골드 소모량 초기화</button>
        </div>
    </div>

    <script>
        const STATS = ['attackBonus', 'critDamage', 'basicAttack', 'critRate'];
        const STAT_LABELS = {
            attackBonus: '공격 보너스',
            critDamage: '치명타 피해',
            basicAttack: '공격력',
            critRate: '치명타'
        };
        const COEFFICIENTS = {
            attack: {
                barrel: {
                    attackBonus: { base: 0.26, weight: 0.026 },
                    critDamage: { base: 0.18, weight: 0.018 },
                    basicAttack: { base: 0.16, weight: 0.016 },
                    critRate: { base: 0.10, weight: 0.010 }
                },
                part: {
                    attackBonus: { base: 0.26, weight: 0.026 },
                    basicAttack: { base: 0.16, weight: 0.016 },
                    critRate: { base: 0.10, weight: 0.010 }
                }
            },
            crit: {
                barrel: {
                    attackBonus: { base: 0.29, weight: 0.029 },
                    critDamage: { base: 0.16, weight: 0.016 },
                    basicAttack: { base: 0.16, weight: 0.016 },
                    critRate: { base: 0.16, weight: 0.016 }
                },
                part: {
                    attackBonus: { base: 0.29, weight: 0.029 },
                    basicAttack: { base: 0.16, weight: 0.016 },
                    critRate: { base: 0.16, weight: 0.016 }
                }
            }
        };

        let state = {
            weaponType: 'attack',
            partType: 'barrel',
            goldSpent: 0,
            attempts: 0,
            reinforcements: Object.fromEntries(STATS.map(stat => [stat, 100]))
        };

        function getStatValue(stat) {
            return document.getElementById(stat)?.value || state.reinforcements[stat];
        }

        function createStatInput(stat) {
            const div = document.createElement('div');
            div.className = 'stat-input';
            div.innerHTML = `
                <label>${STAT_LABELS[stat]}</label>
                <select id="${stat}" class="stat-value" onchange="updateStats()">
                    <option value="0">0</option>
                    ${Array.from({length: 20}, (_, i) => `
                        <option value="${(i + 1) * 10}">${(i + 1) * 10}%</option>
                    `).join('')}
                </select>
            `;
            return div;
        }

        function calculateDamage(values, type, part) {
            const coef = COEFFICIENTS[type][part];
            let score = 0;
            
            score += coef.attackBonus.base + coef.attackBonus.weight * values.attackBonus;
            if (part === 'barrel') {
                score += coef.critDamage.base + coef.critDamage.weight * values.critDamage;
            }
            score += coef.basicAttack.base + coef.basicAttack.weight * values.basicAttack;
            score += coef.critRate.base + coef.critRate.weight * values.critRate;
            
            return score;
        }

        function calculateMaxDamage() {
            return calculateDamage({
                attackBonus: 20,
                critDamage: 20,
                basicAttack: 20,
                critRate: 20
            }, state.weaponType, state.partType);
        }

        function calculatePercentile(score) {
            let betterOutcomes = 0;
            const iterations = 100000;
            
            for(let i = 0; i < iterations; i++) {
                const simValues = {
                    attackBonus: Math.floor(Math.random() * 20) + 1,
                    critDamage: state.partType === 'barrel' ? Math.floor(Math.random() * 20) + 1 : 1,
                    basicAttack: Math.floor(Math.random() * 20) + 1,
                    critRate: Math.floor(Math.random() * 20) + 1
                };
                if(calculateDamage(simValues, state.weaponType, state.partType) > score) {
                    betterOutcomes++;
                }
            }
            
            return (betterOutcomes / iterations * 100).toFixed(3);
        }

        function updateStats() {
            STATS.forEach(stat => {
                const value = getStatValue(stat);
                if (value !== undefined) {
                    state.reinforcements[stat] = parseInt(value);
                }
            });
            updateDisplay();
        }

        function updateDisplay() {
            const normalized = Object.fromEntries(
                Object.entries(state.reinforcements)
                .map(([key, value]) => [key, value / 10])
            );

            const currentScore = calculateDamage(normalized, state.weaponType, state.partType);
            const maxScore = calculateMaxDamage();
            const percentile = calculatePercentile(currentScore);

            document.getElementById('damageStats').innerHTML = `
                <div>현재 점수: ${currentScore.toFixed(4)}</div>
                <div>최대 점수: ${maxScore.toFixed(4)}</div>
                <div>최대 대비: ${((currentScore / maxScore) * 100).toFixed(2)}%</div>
                <div>상위 ${percentile}% 수준의 옵션입니다</div>
            `;

            document.getElementById('goldStats').innerHTML = `
                <div>시도 횟수: ${state.attempts}회</div>
                <div>소모된 골드: ${state.goldSpent.toLocaleString()}골드</div>
            `;
        }

        function simulate() {
            const currentValues = Object.fromEntries(
                STATS.map(stat => [stat, parseInt(getStatValue(stat))])
            );

            const newReinforcements = {};
            STATS.forEach(stat => {
                if (currentValues[stat] === 0) {
                    newReinforcements[stat] = 0;
                } else {
                    newReinforcements[stat] = Math.floor(Math.random() * 20) * 10 + 10;
                }
                if (stat === 'critDamage' && state.partType === 'part') {
                    newReinforcements[stat] = 0;
                }
            });

            state.reinforcements = newReinforcements;
            state.goldSpent += 20000;
            state.attempts += 1;

            // UI 업데이트
            STATS.forEach(stat => {
                const select = document.getElementById(stat);
                if (select) {
                    select.value = newReinforcements[stat];
                }
            });

            updateDisplay();
        }

        function resetStats() {
            state.goldSpent = 0;
            state.attempts = 0;
            updateDisplay();
        }

        function init() {
            document.getElementById('weaponType').onchange = e => {
                state.weaponType = e.target.value;
                updateDisplay();
            };

            document.getElementById('partType').onchange = e => {
                state.partType = e.target.value;
                if (e.target.value === 'part') {
                    state.reinforcements.critDamage = 0;
                }
                initStatInputs();
                updateDisplay();
            };

            initStatInputs();
            updateDisplay();
        }

        function initStatInputs() {
            const container = document.getElementById('statInputs');
            container.innerHTML = '';
            STATS.forEach(stat => {
                if (stat !== 'critDamage' || state.partType === 'barrel') {
                    container.appendChild(createStatInput(stat));
                }
            });

            // 이전 값 복원
            STATS.forEach(stat => {
                const select = document.getElementById(stat);
                if (select) {
                    select.value = state.reinforcements[stat];
                }
            });
        }

        init();
    </script>
</body>
</html>